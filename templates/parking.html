<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Parking Dashboard â€” PR10</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</head>

<body>
    <div class="container">

        <!-- LIVE PARKING DASHBOARD -->
        <header>
            <h1>ðŸš— Live Parking Dashboard â€” PR10</h1>
            <div class="controls">
                <button class="btn" id="refreshBtn">Refresh now</button>
                <label class="small">Poll interval:
                    <select id="intervalSelect" class="btn" style="padding:6px 10px">
                        <option value="2000">2s</option>
                        <option value="5000" selected>5s</option>
                        <option value="10000">10s</option>
                        <option value="30000">30s</option>
                    </select>
                </label>
            </div>
        </header>

        <main class="map">
            <div class="left-col">
                <div class="entry-exit">
                    <div class="spot">
                        <div class="spot-label">Entry Gate</div>
                        <div class="spot-value">A1</div>
                    </div>
                    <div class="spot">
                        <div class="spot-label">Exit Gate</div>
                        <div class="spot-value">B2</div>
                    </div>
                </div>

                <div class="map-area">
                    <div class="parking-grid">
                        <div class="lot" id="slot1">Slot 1<div class="sub">Empty</div>
                        </div>
                        <div class="lot" id="slot2">Slot 2<div class="sub">Empty</div>
                        </div>
                        <div class="lot" id="slot3">Slot 3<div class="sub">Empty</div>
                        </div>
                        <div class="lot nopark">No Parking<div class="sub">Restricted</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="side-info">
                <div class="meta">
                    <div><strong>Device UID:</strong> {{ DEVICE_UID }}</div>
                    <div><strong>IoT Endpoint:</strong> {{ IOT_BASE_URL }}</div>
                    <div class="status-row">
                        <div class="dot free"></div> Free
                        <div class="dot occ"></div> Occupied
                    </div>
                </div>
            </div>
        </main>

        <footer><span>Â© 2025 PR10 Parking System</span></footer>

        <!-- HEATMAP SECTION -->
        <section class="chart-container">
            <h2>ðŸ“Š Parking Occupancy Heatmap</h2>
            <canvas id="heatmapChart" width="800" height="400"></canvas>
        </section>

        <!-- PREDICTOR SECTION -->
        <section class="predictor chart-container">
            <h2>ðŸ§  Parking Predictor</h2>
            <form method="POST" action="/predictor">
                <label>Day:</label>
                <select name="day">
                    <option>Monday</option>
                    <option>Tuesday</option>
                    <option>Wednesday</option>
                    <option>Thursday</option>
                    <option>Friday</option>
                    <option>Saturday</option>
                    <option>Sunday</option>
                </select>

                <label>Hour:</label>
                <input type="number" name="hour" min="0" max="23" value="12">
                <button type="submit">Predict</button>
            </form>

            {% if prediction is not none %}
            <div id="predictResult">
                Predicted average stay at {{ hour }}:00 on {{ day }} = <strong>{{ prediction }} minutes</strong>
            </div>
            {% endif %}
        </section>
    </div>

    <script>
        // --- LIVE UPDATE SCRIPT ---
        async function fetchSlots() {
            const res = await fetch("{{ IOT_BASE_URL }}=get_parking_status&uid={{ DEVICE_UID }}");
            const data = await res.json();

            for (const [slot, info] of Object.entries(data)) {
                const el = document.getElementById(slot);
                if (!el) continue;
                el.classList.remove("free", "occupied", "blink");

                if (info.status === "occupied") {
                    el.classList.add("occupied");
                    el.querySelector(".sub").innerText = "Occupied";
                } else if (info.status === "nopark") {
                    el.classList.add("nopark");
                    el.querySelector(".sub").innerText = "No Parking";
                } else {
                    el.classList.add("free");
                    el.querySelector(".sub").innerText = "Free";
                }
            }
        }

        let pollInterval = 5000;
        document.getElementById("intervalSelect").addEventListener("change", e => {
            pollInterval = parseInt(e.target.value);
        });

        document.getElementById("refreshBtn").addEventListener("click", fetchSlots);

        setInterval(fetchSlots, pollInterval);
        fetchSlots();

        // --- HEATMAP CHART ---
        fetch("/heatmap_data")
            .then(res => res.json())
            .then(heatmapData => {
                const days = Object.keys(heatmapData);
                const hours = Array.from({ length: 24 }, (_, i) => i + ":00");
                const datasets = days.map((day, idx) => ({
                    label: day,
                    data: heatmapData[day] || Array(24).fill(0),
                    borderWidth: 1,
                    backgroundColor: `rgba(${(idx * 40) % 255}, ${(idx * 90) % 255}, 255, 0.4)`
                }));

                new Chart(document.getElementById("heatmapChart"), {
                    type: "line",
                    data: { labels: hours, datasets },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: "Avg Duration (s)" } },
                            x: { title: { display: true, text: "Hour of Day" } }
                        }
                    }
                });
            });
    </script>
</body>

</html>